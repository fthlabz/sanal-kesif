<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanal Keşif | Müşteri Vitrini</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #f4f4f4; }
        
        /* 3D Ürün Alanı - Kırmızı Koltuktaki gibi tam ekran ve çevrilebilir */
        model-viewer { width: 100vw; height: 100vh; outline: none; background-color: #f4f4f4; }
        
        /* Yükleniyor Uyarıları */
        #loading-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f4f4f4; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #333; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Alt Kontrol Paneli - Senin beğendiğin şık tasarım */
        .ui-panel { position: absolute; bottom: 0; width: 100%; background: white; padding: 20px 15px; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); box-sizing: border-box; z-index: 10; }
        
        /* Kaydırma ve Bilgi */
        .nav-buttons { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .nav-btn { background: #e9ecef; border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; color: #333; transition: 0.2s; }
        .nav-btn:active { background: #d3d9df; }
        .info-area { text-align: center; }
        .info-area h3 { margin: 0; font-size: 16px; color: #111; }
        .info-area p { margin: 3px 0 0 0; font-size: 13px; color: #007bff; font-weight: bold; }
        
        /* Sihirli AR Butonu */
        .ar-btn { background: #111; color: #fff; border: none; padding: 15px; width: 100%; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <strong style="color:#555">Sanal Keşif Hazırlanıyor...</strong>
    </div>

    <model-viewer id="rugViewer"
        src="https://modelviewer.dev/shared-assets/models/glTF-Sample-Assets/Models/Box/glTF-Binary/Box.glb"
        ar ar-modes="webxr scene-viewer quick-look"
        camera-controls shadow-intensity="1" auto-rotate exposure="0.8">
    </model-viewer>

    <div class="ui-panel">
        <div class="nav-buttons">
            <button class="nav-btn" onclick="degistir(-1)">⬅ Önceki</button>
            <div class="info-area">
                <h3 id="urunAdi">Model Seçiliyor...</h3>
                <p id="urunOlcu">...</p>
            </div>
            <button class="nav-btn" onclick="degistir(1)">Sonraki ➡</button>
        </div>
        <button class="ar-btn" onclick="document.querySelector('#rugViewer').activateAR()">Evimde Gör (Kamerayı Aç)</button>
    </div>

    <script>
        const vitrin = JSON.parse(localStorage.getItem('bunkervanVitrin')) || [];
        let aktifIndex = 0;
        
        const mv = document.getElementById('rugViewer');
        const isimText = document.getElementById('urunAdi');
        const olcuText = document.getElementById('urunOlcu');
        const loadingScreen = document.getElementById('loading-screen');

        // Safari'nin Güvenliğini Delen CDN Hilesi
        function cdnLinkYap(orijinalUrl) {
            // raw.githubusercontent adresini, güvenli jsDelivr adresine çevirir
            if(orijinalUrl.includes("raw.githubusercontent.com")) {
                let yeniUrl = orijinalUrl.replace("raw.githubusercontent.com", "cdn.jsdelivr.net/gh");
                yeniUrl = yeniUrl.replace("/main/", "@main/");
                return yeniUrl;
            }
            return orijinalUrl;
        }

        async function haliyiYukle(index) {
            if (vitrin.length === 0) {
                loadingScreen.style.display = 'none';
                isimText.innerText = "Vitrin Boş";
                olcuText.innerText = "Esnaf ürün yüklemedi.";
                return;
            }

            loadingScreen.style.display = 'flex'; // Yükleniyor ekranını aç
            const urun = vitrin[index];
            isimText.innerText = `Ürün ${index + 1} / ${vitrin.length}`;
            olcuText.innerText = `Ölçü: ${urun.en}x${urun.boy} cm`;

            // 1. Ölçüyü Halı Ebatına (İncecik) Getir
            mv.scale = `${urun.en / 100} 0.01 ${urun.boy / 100}`;

            try {
                // Güvenli CDN linkini oluştur
                const guvenliLink = cdnLinkYap(urun.url);

                // Resmi çekip dokuya çevir (Safari artık engellemeyecek)
                const texture = await mv.createTexture(guvenliLink);
                const material = mv.model.materials[0];
                material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
                material.pbrMetallicRoughness.setBaseColorFactor([1, 1, 1, 1]); 
                
                loadingScreen.style.display = 'none'; // Yükleniyor ekranını kapat

            } catch (error) {
                console.error("Doku hatası:", error);
                olcuText.innerText = "Resim yüklenemedi. Lütfen sayfayı yenileyin.";
                loadingScreen.style.display = 'none';
            }
        }

        // Sağ-Sol Kaydırma
        window.degistir = function(yon) {
            if (vitrin.length === 0) return;
            aktifIndex += yon;
            if (aktifIndex >= vitrin.length) aktifIndex = 0; 
            if (aktifIndex < 0) aktifIndex = vitrin.length - 1; 
            haliyiYukle(aktifIndex);
        }

        // Sayfa açılınca, Model Viewer'ın "hazır" olmasını bekle ve halıyı bas
        mv.addEventListener('load', () => {
            haliyiYukle(aktifIndex);
        });
    </script>

</body>
</html>
