<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Y√∂netim Paneli | Final Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #09090b;
            --card: #18181b;
            --input: #27272a;
            --border: #3f3f46;
            --text: #ffffff;
            --accent: #2563eb;
            --danger: #ef4444;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); color: var(--text);
            margin: 0; padding: 20px 15px;
            overflow-x: hidden;
        }

        .container { max-width: 550px; margin: 0 auto; padding-bottom: 60px; }
        
        h2 { text-align: center; margin: 0 0 5px; font-size: 22px; }
        .subtitle { text-align: center; color: #a1a1aa; font-size: 13px; margin-bottom: 25px; }

        /* --- FOTOƒûRAF Y√úKLEME --- */
        .upload-area {
            background: var(--card); border: 2px dashed var(--border);
            border-radius: 16px; padding: 20px; text-align: center;
            margin-bottom: 20px; position: relative;
        }
        
        .file-trigger { display: block; padding: 30px 0; cursor: pointer; }
        #fileInput { display: none; }
        
        #previewBox {
            width: 100px; height: 100px; object-fit: cover; 
            border-radius: 10px; margin: 10px auto; display: none; border: 2px solid var(--accent);
        }

        /* --- FORMLAR --- */
        .input-stack { display: flex; flex-direction: column; gap: 12px; }
        
        input { 
            width: 100%; padding: 14px; 
            background: var(--input); border: 1px solid var(--border);
            border-radius: 10px; color: white; font-size: 15px;
            box-sizing: border-box;
        }
        input:focus { border-color: var(--accent); outline: none; }

        .row { display: flex; gap: 10px; }
        .row input { flex: 1; }

        .btn-main {
            width: 100%; padding: 16px; margin-top: 15px;
            background: var(--accent); color: white; border: none;
            border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer;
        }
        .btn-main:active { opacity: 0.9; }

        /* --- Lƒ∞STE TASARIMI --- */
        .section-header { 
            margin-top: 40px; border-bottom: 1px solid var(--border); 
            padding-bottom: 10px; margin-bottom: 15px; font-weight: 600; font-size: 16px;
        }

        .item { 
            background: var(--card); padding: 10px; border-radius: 12px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 10px; border: 1px solid var(--border);
        }
        .item-left { display: flex; align-items: center; gap: 12px; }
        .item-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #333; }
        .item-info h4 { margin: 0; font-size: 14px; }
        .item-info p { margin: 2px 0 0; font-size: 12px; color: #a1a1aa; }
        
        .btn-del { 
            background: rgba(239, 68, 68, 0.2); color: var(--danger);
            border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold;
        }

        /* --- AR≈ûƒ∞V GRID --- */
        .archive-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .archive-item {
            position: relative; aspect-ratio: 1; border-radius: 10px; overflow: hidden;
            border: 2px solid transparent; cursor: pointer;
        }
        .archive-item img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; transition: 0.2s; }
        .archive-item:hover img { opacity: 1; }
        .archive-tag {
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: rgba(37, 99, 235, 0.9); color: white; 
            font-size: 10px; text-align: center; padding: 4px;
        }

        #status { text-align: center; color: var(--accent); margin-top: 10px; font-size: 13px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>Maƒüaza Paneli</h2>
    <div class="subtitle">Vitrin Y√∂netimi</div>

    <div class="upload-area">
        <label class="file-trigger" for="fileInput">
            <span style="font-size: 24px;">üì∏</span><br>
            <span id="fileLabel" style="color:#a1a1aa; font-size:14px;">Fotoƒüraf Se√ßmek ƒ∞√ßin Tƒ±kla</span>
        </label>
        <input type="file" id="fileInput" accept="image/*" onchange="resimSecildi()">
        <img id="previewBox">
        
        <div class="input-stack">
            <input type="text" id="name" placeholder="√úr√ºn Adƒ± (√ñrn: Gri Halƒ±)">
            <div class="row">
                <input type="number" id="price" placeholder="Fiyat (TL)">
                <input type="text" id="sku" placeholder="Stok Kodu">
            </div>
            <div class="row">
                <input type="number" id="width" placeholder="En (cm)">
                <input type="number" id="height" placeholder="Boy (cm)">
            </div>
            <input type="text" id="coll" placeholder="Koleksiyon">
            
            <button class="btn-main" onclick="urunuYukle()">‚ú® Vitrine Ekle</button>
            <div id="status">ƒ∞≈ülem yapƒ±lƒ±yor...</div>
        </div>
    </div>

    <div class="section-header">Yayƒ±ndaki √úr√ºnler</div>
    <div id="activeList">Y√ºkleniyor...</div>

    <div class="section-header">‚òÅÔ∏è Ar≈üiv (Geri Y√ºkle)</div>
    <div id="archiveGrid" class="archive-grid"></div>
</div>

<script>
    // --- TOKEN AYARLARI ---
    const USER = "fthlabz"; 
    const REPO = "sanal-kesif"; 
    const t1 = "ghp_"; 
    const t2 = "dm7qeynDwgjzBO5uOg02AFW4OhXZXH1cMdUG"; // <--- BURAYA TOKENƒ∞ YAPI≈ûTIR
    const TOKEN = t1 + t2;

    let vitrin = [];

    init();

    async function init() {
        try {
            const res = await fetch(`https://raw.githubusercontent.com/${USER}/${REPO}/main/vitrin.json?t=${Date.now()}`);
            if(res.ok) vitrin = await res.json();
        } catch(e) {}
        
        listeyiCiz();
        arsiviTara();
    }

    function resimSecildi() {
        const file = document.getElementById('fileInput').files[0];
        if (file) {
            document.getElementById('fileLabel').innerText = "‚úÖ " + file.name;
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('previewBox').src = e.target.result;
                document.getElementById('previewBox').style.display = "block";
            }
            reader.readAsDataURL(file);
        }
    }

    // --- KRƒ∞Tƒ∞K D√úZELTME: G√úVENLƒ∞ Y√úKLEME ---
    async function urunuYukle() {
        const file = document.getElementById('fileInput').files[0];
        // Verileri Garanti Al
        const name = document.getElementById('name').value;
        const price = document.getElementById('price').value;
        const w = document.getElementById('width').value;
        const h = document.getElementById('height').value;
        const sku = document.getElementById('sku').value || "Kod Yok";
        const coll = document.getElementById('coll').value || "Genel";

        if(!name || !price || !w || !h) { alert("L√ºtfen √úr√ºn Adƒ±, Fiyat, En ve Boy bilgilerini doldurun."); return; }
        if(!file) { alert("L√ºtfen bir fotoƒüraf se√ßin."); return; }

        durum("Fotoƒüraf Hazƒ±rlanƒ±yor... ‚öôÔ∏è");
        
        // 1. Resmi Hazƒ±rla
        const base64 = await resizeImage(file);
        const fileName = `images/p_${Date.now()}.jpg`;

        durum("Buluta G√∂nderiliyor... ‚òÅÔ∏è");
        
        // 2. Resmi Y√ºkle
        const imgUrl = await uploadToGithub(fileName, base64);
        
        if(imgUrl) {
            durum("Liste G√ºncelleniyor... üìù");
            
            // 3. Listeyi G√úNCEL HALƒ∞YLE √áek (Senkronizasyon Hatasƒ±nƒ± √ñnler)
            await tazeVeriCek();

            const yeniUrun = {
                id: Date.now(),
                url: imgUrl,
                name: name,      // undefined olamaz artƒ±k
                price: price,
                sku: sku,
                en: w,
                boy: h,
                collection: coll,
                inStock: true
            };

            vitrin.push(yeniUrun);
            
            // 4. JSON'u G√ºncelle
            const basari = await updateJson(vitrin);
            
            if(basari) {
                durum("‚úÖ Ba≈üarƒ±lƒ±! Sayfa Yenileniyor...");
                setTimeout(() => location.reload(), 1500);
            } else {
                durum("‚ùå Hata: Liste g√ºncellenemedi! (Resim ar≈üivde)");
                alert("Resim y√ºklendi ama listeye eklenemedi. Sayfayƒ± yenileyip Ar≈üiv'den ekleyebilirsiniz.");
            }
        }
    }

    // --- Sƒ∞LME VE AR≈ûƒ∞VLEME ---
    async function sil(id) {
        if(confirm("Bu √ºr√ºn√º vitrinden kaldƒ±rmak istiyor musunuz?")) {
            durum("Siliniyor...");
            await tazeVeriCek(); // Silmeden √∂nce de tazele
            vitrin = vitrin.filter(x => x.id !== id);
            await updateJson(vitrin);
            listeyiCiz();
            arsiviTara();
            durum("Kaldƒ±rƒ±ldƒ±.");
        }
    }

    async function arsivdenGeriYukle(url) {
        const ad = prompt("√úr√ºn Adƒ±:", "Ar≈üiv √úr√ºn√º");
        if(!ad) return;
        
        durum("Geri Y√ºkleniyor...");
        await tazeVeriCek(); // √áakƒ±≈ümayƒ± √∂nle

        const yeni = {
            id: Date.now(),
            url: url,
            name: ad,
            price: prompt("Fiyat:", "0"),
            sku: "ARSV-01",
            en: prompt("En:", "160"),
            boy: prompt("Boy:", "230"),
            collection: "Ar≈üiv",
            inStock: true
        };

        vitrin.push(yeni);
        await updateJson(vitrin);
        
        listeyiCiz();
        arsiviTara();
        durum("Geri Y√ºklendi! ‚úÖ");
    }

    // --- YARDIMCI MOTORLAR ---
    
    // En G√ºncel Veriyi √áeken Fonksiyon (Hata √ñnleyici)
    async function tazeVeriCek() {
        try {
            // Cache busting ile √ßek
            const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/vitrin.json?t=${Date.now()}`, {
                 headers: { 'Authorization': `token ${TOKEN}` }
            });
            if(res.ok) {
                const data = await res.json();
                // Base64 decode
                const content = decodeURIComponent(escape(atob(data.content)));
                vitrin = JSON.parse(content);
                return data.sha; // SHA'yƒ± d√∂nd√ºr
            }
        } catch(e) { console.log("Veri √ßekme hatasƒ±", e); }
        return null;
    }

    async function arsiviTara() {
        try {
            const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/images`, {
                headers: { 'Authorization': `token ${TOKEN}` }
            });
            
            if(res.ok) {
                const tumDosyalar = await res.json();
                const aktifLinkler = vitrin.map(item => item.url);
                
                const arsivlik = tumDosyalar.filter(dosya => 
                    !aktifLinkler.includes(dosya.download_url) &&
                    (dosya.name.endsWith('.jpg') || dosya.name.endsWith('.png'))
                );

                const grid = document.getElementById('archiveGrid');
                grid.innerHTML = "";
                
                if(arsivlik.length === 0) {
                    grid.innerHTML = "<p style='color:#555; font-size:12px; grid-column:span 3; text-align:center;'>Ar≈üiv bo≈ü.</p>";
                    return;
                }

                arsivlik.forEach(dosya => {
                    grid.innerHTML += `
                        <div class="archive-item" onclick="arsivdenGeriYukle('${dosya.download_url}')">
                            <img src="${dosya.download_url}">
                            <div class="archive-tag">GERƒ∞ Y√úKLE</div>
                        </div>
                    `;
                });
            }
        } catch(e) {}
    }

    function listeyiCiz() {
        const list = document.getElementById('activeList');
        list.innerHTML = "";
        
        vitrin.slice().reverse().forEach(p => {
            // undefined kontrol√º
            const isim = p.name || "ƒ∞simsiz";
            const fiyat = p.price || "0";
            
            list.innerHTML += `
                <div class="item">
                    <div class="item-left">
                        <img src="${p.url}" class="item-img">
                        <div class="item-info">
                            <h4>${isim}</h4>
                            <p>${p.sku || ""} ‚Ä¢ ${fiyat} TL</p>
                        </div>
                    </div>
                    <button class="btn-del" onclick="sil(${p.id})">Kaldƒ±r</button>
                </div>
            `;
        });
    }

    async function updateJson(data) {
        const url = `https://api.github.com/repos/${USER}/${REPO}/contents/vitrin.json`;
        
        // √ñnce SHA al
        let sha = await tazeVeriCek(); // Bu fonksiyon vitrin'i de g√ºnceller ama biz √ºst√ºne yazacaƒüƒ±z
        
        // Base64 encode (T√ºrk√ße karakter sorunu √ß√∂z√ºm√º ile)
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
        
        try {
            const res = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: "Panel Update",
                    content: content,
                    sha: sha || undefined
                })
            });
            return res.ok;
        } catch(e) { return false; }
    }

    function resizeImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 1000;
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > MAX) { h *= MAX / w; w = MAX; } }
                    else { if (h > MAX) { w *= MAX / h; h = MAX; } }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.85).split(',')[1]);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function uploadToGithub(path, content) {
        try {
            const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${path}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "New Image", content: content })
            });
            const d = await res.json();
            return d.content.download_url;
        } catch(e) { return null; }
    }

    function durum(msg) {
        const el = document.getElementById('status');
        el.style.display = 'block'; el.innerText = msg;
    }
</script>

</body>
</html>
