<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanal Keşif | Müşteri Vitrini</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: '-apple-system', BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f4f4f4; }
        
        model-viewer { width: 100vw; height: 100vh; outline: none; background-color: #f4f4f4; }
        
        /* Yükleniyor Ekranı */
        #loading-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f4f4f4; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #333; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Alt Bilgi Paneli (Daha Şık) */
        .ui-panel { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 15px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        
        .nav-btn { background: #e9ecef; border: none; padding: 10px 15px; border-radius: 12px; font-weight: bold; font-size: 14px; cursor: pointer; color: #333; }
        .info-area { text-align: center; }
        .info-area h3 { margin: 0; font-size: 16px; color: #111; }
        .info-area p { margin: 3px 0 0 0; font-size: 13px; color: #007bff; font-weight: bold; }
        
        /* İŞTE YENİ PREMIUM AR BUTONU (Apple Standartlarında) */
        .premium-ar-btn { 
            position: absolute; 
            bottom: 40px; 
            left: 50%; 
            transform: translateX(-50%); 
            background-color: #1a1a1a; 
            color: #ffffff; 
            border: none; 
            padding: 16px 30px; 
            border-radius: 30px; 
            font-size: 17px; 
            font-weight: 600; 
            cursor: pointer; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.3); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            width: 80%; 
            max-width: 350px; 
            justify-content: center;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <strong id="loading-text" style="color:#555">Sanal Keşif Hazırlanıyor...</strong>
    </div>

    <model-viewer id="rugViewer"
        src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/BoxTextured/glTF-Binary/BoxTextured.glb"
        ar ar-modes="webxr scene-viewer quick-look"
        camera-controls shadow-intensity="1.5" auto-rotate exposure="0.8">
        
        <button slot="ar-button" class="premium-ar-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            Evimde Gör (AR)
        </button>
    </model-viewer>

    <div class="ui-panel">
        <button class="nav-btn" onclick="degistir(-1)">⬅</button>
        <div class="info-area">
            <h3 id="urunAdi">Hazırlanıyor...</h3>
            <p id="urunOlcu">...</p>
        </div>
        <button class="nav-btn" onclick="degistir(1)">➡</button>
    </div>

    <script>
        const vitrin = JSON.parse(localStorage.getItem('bunkervanVitrin')) || [];
        let aktifIndex = 0;
        
        const mv = document.getElementById('rugViewer');
        const isimText = document.getElementById('urunAdi');
        const olcuText = document.getElementById('urunOlcu');
        const loadingScreen = document.getElementById('loading-screen');
        const loadingText = document.getElementById('loading-text');

        // Apple Donma Hatasını Çözen Doğrudan Link Çevirici
        function cdnLinkYap(orijinalUrl) {
            if(orijinalUrl.includes("raw.githubusercontent.com")) {
                let p = orijinalUrl.split('/');
                return `https://cdn.jsdelivr.net/gh/${p[3]}/${p[4]}@${p[5]}/${p.slice(6).join('/')}`;
            }
            return orijinalUrl;
        }

        async function haliyiYukle(index) {
            if (vitrin.length === 0) {
                loadingScreen.style.display = 'none';
                isimText.innerText = "Vitrin Boş"; return;
            }

            loadingScreen.style.display = 'flex';
            loadingText.innerText = "Halı Dokunuyor...";
            
            const urun = vitrin[index];
            isimText.innerText = `Ürün ${index + 1} / ${vitrin.length}`;
            olcuText.innerText = `${urun.en}x${urun.boy} cm`;

            mv.scale = `${urun.en / 100} 0.05 ${urun.boy / 100}`;

            try {
                // BLOB HİLESİNİ KALDIRDIK! Direkt güvenli linkten alıyoruz (AR Donmasını Çözer)
                const guvenliLink = cdnLinkYap(urun.url);
                const texture = await mv.createTexture(guvenliLink);
                const material = mv.model.materials[0];
                material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
                material.pbrMetallicRoughness.setBaseColorFactor([1, 1, 1, 1]); 
                
                loadingScreen.style.display = 'none';

            } catch (error) {
                console.error(error);
                loadingText.innerText = "Bağlantı zayıf, sayfayı yenileyin.";
            }
        }

        window.degistir = function(yon) {
            if (vitrin.length === 0) return;
            aktifIndex += yon;
            if (aktifIndex >= vitrin.length) aktifIndex = 0; 
            if (aktifIndex < 0) aktifIndex = vitrin.length - 1; 
            haliyiYukle(aktifIndex);
        }

        mv.addEventListener('load', () => haliyiYukle(aktifIndex));
    </script>

</body>
</html>
